#!/bin/bash

# Source code provided to directory
S2I_SOURCE_DIR=${S2I_SOURCE_DIR-"/tmp/src"}

# Clean home for test run user (unknown uid)
export HOME=/tmp/nohome

# runs one test
function testrun() {
    echo "---> Testing application"
    (cd $S2I_SOURCE_DIR; yarn workspace @frontend/webcert-e2e cy:run)
    ERR=$?
    return $ERR
}

# saves result report
function save_report() {
    SRC=$(dirname $1)/${2}.html
    mv $1 $SRC
    DST="${REPORT_DIR}/${2}/${2}.html"
    echo "---> Save report $SRC as $DST"
    if [ -f $SRC ]; then
        DIR=$(dirname $DST)
        [ -f $DST ] && rm -rf $DIR
        if [ "$3" == "d" ]; then
            cp -r $(dirname $SRC) $DIR
        else
            mkdir -p $DIR
            cp ${SRC} ${DST}
        fi
    fi
}

# loop through all tests
if [ $# -gt 1  ] && [ "$1" = "testrun" ]; then
    echo "---> User $(id) home is $HOME"
    echo "---> Report dir is $REPORT_DIR"
    mkdir -p $REPORT_DIR
    RESULT=SUCCESS

    testrun $TEST
    [ $? -ne 0 ] && RESULT=FAILED
    save_report ${S2I_SOURCE_DIR}/test/build/test-results/mochawesome.html $TEST d

    # Report back
    echo "---> Done, report back status $RESULT to $CALLBACK_URL"
    curl -X POST -k -d $RESULT $CALLBACK_URL
else
    $(dirname "$0")/usage
fi
